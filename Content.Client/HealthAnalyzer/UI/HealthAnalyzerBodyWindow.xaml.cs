using Content.Shared.Body.Systems;
using Content.Shared.MedicalScanner;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.HealthAnalyzer.UI;

[GenerateTypedNameReferences]
public sealed partial class HealthAnalyzerBodyWindow : BaseHealthAnalyzerWindow
{
    private readonly SharedBodySystem _bodySystem;

    private readonly Dictionary<HealthAnalyzerType, BaseHealthAnalyzerBodyTab> _tabs = [];

    public bool Updateable = true;

    public HealthAnalyzerBodyWindow()
    {
        RobustXamlLoader.Load(this);

        _bodySystem = EntityManager.System<SharedBodySystem>();
    }

    public override void Populate(HealthAnalyzerScannedUserMessage msg)
    {
        var uid = EntityManager.GetEntity(msg.TargetEntity);

        Entity<HealthAnalyzerBodyComponent>? ent;
        if (uid == null)
            ent = null;
        else
            ent = (uid.Value, EntityManager.GetComponent<HealthAnalyzerBodyComponent>(uid.Value));

        foreach (var type in Enum.GetValues<HealthAnalyzerType>().Where(e => e != 0 && ((byte)e & (byte)e - 1) == 0 && msg.Type.HasFlag(e)))
        {
            if (!_tabs.TryGetValue(type, out var tab))
            {
                tab = type switch
                {
                    HealthAnalyzerType.Body => new HealthAnalyzerBodyBodyTab(this, EntityManager, _bodySystem, Prototypes, SpriteSystem),
                    HealthAnalyzerType.Organs => new HealthAnalyzerBodyOrganTab(this, EntityManager, _bodySystem, Prototypes, SpriteSystem),
                    _ => throw new NotImplementedException()
                };

                _tabs[type] = tab;
                Tabs.AddChild(tab);
            }

            tab.Populate(ent, msg);
        }
    }
}
