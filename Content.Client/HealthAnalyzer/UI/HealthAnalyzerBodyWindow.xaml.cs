using Content.Shared.Body.Part;
using Content.Shared.Body.Systems;
using Content.Shared.Damage;
using Content.Shared.MedicalScanner;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.HealthAnalyzer.UI;

[GenerateTypedNameReferences]
public sealed partial class HealthAnalyzerBodyWindow : BaseHealthAnalyzerWindow
{
    private readonly SharedBodySystem _bodySystem;

    private BodyPart? _selectedPart;
    public bool Updateable = true;

    public HealthAnalyzerBodyWindow()
    {
        RobustXamlLoader.Load(this);

        _bodySystem = EntityManager.System<SharedBodySystem>();
    }

    public override void Populate(HealthAnalyzerScannedUserMessage msg)
    {
        var target = EntityManager.GetEntity(msg.TargetEntity);

        if (target == null || _bodySystem.GetBodyDamage(target.Value) is not { } damage)
        {
            NoPatientDataText.Visible = true;
            return;
        }

        NoPatientDataText.Visible = false;

        DrawScanMode(ScanModeLabel, msg.ScanMode);
        DrawPatient(SpriteView, NoDataTex, NameLabel, SpeciesLabel, target.Value, msg.ScanMode);
        DrawBasicDiagnostics(TemperatureLabel, BloodLabel, StatusLabel, DamageLabel, target.Value, msg.Temperature, msg.BloodLevel, damage.GetTotal());

        var showAlerts = DrawAlerts(AlertsContainer, msg.Unrevivable, msg.Bleeding);
        AlertsDivider.Visible = showAlerts;
        AlertsContainer.Visible = showAlerts;

        LimbButton.RemoveAllChildren();

        var healthBodyComp = EntityManager.GetComponent<HealthAnalyzerBodyComponent>(target.Value);

        Dictionary<BodyPart, (Entity<DamageableComponent> Entity, HealthAnalyzerBodyButton Button)> limbs = [];

        foreach (var (limbUid, limbComp) in _bodySystem.GetBodyChildren(target.Value))
        {
            var part = new BodyPart(limbComp.PartType, limbComp.Symmetry);
            if (!EntityManager.TryGetComponent<HealthAnalyzerBodyItemComponent>(limbUid, out var data))
                continue;

            if (!EntityManager.TryGetComponent<DamageableComponent>(limbUid, out var damageable))
                continue;

            if (!EntityManager.TryGetComponent<BodyPartThresholdsComponent>(limbUid, out var thresholdsComp) || !thresholdsComp.Thresholds.TryGetValue(WoundState.Dead, out var deadThreshold))
                continue;

            var progressBar = GetProgressBar(data.ProgressBarLocation);
            progressBar.Visible = true;

            progressBar.ProgressLabel.Text = Loc.GetString($"health-analyzer-body-{part.Side.ToString().ToLower()}-{part.Type.ToString().ToLower()}");
            progressBar.ProgressTex.Progress = Math.Abs((float)(damageable.TotalDamage / deadThreshold) - 1);
            progressBar.ProgressText.Text = $"{deadThreshold - damageable.TotalDamage}/{deadThreshold}";

            var button = new HealthAnalyzerBodyButton(data.HoverSprite, data.SelectedSprite, SpriteSystem);
            LimbButton.AddChild(button);

            limbs.Add(part, ((limbUid, damageable), button));
        }

        Updateable = true;

        LimbButton.OnPressed += args =>
        {
            if (!Updateable)
                return;

            foreach (var (part, (_, button)) in limbs)
            {
                if (!button.IsSelected(args.Event.RelativePosition, LimbButton.Size))
                    continue;

                if (_selectedPart == part)
                    _selectedPart = null;
                else
                    _selectedPart = part;

                break;
            }

            Updateable = false;
        };

        if (_selectedPart is { } && limbs.TryGetValue(_selectedPart, out var limbData))
        {
            DrawLimbDamage(limbData.Entity.Comp.Damage);
            limbData.Button.Selected();
            LimbDamageLabel.Text = Loc.GetString($"[font size=16]{Loc.GetString($"health-analyzer-body-{_selectedPart.Side.ToString().ToLower()}-{_selectedPart.Type.ToString().ToLower()}")}[/font]");
        }
        else
        {
            foreach (var (part, (limb, button)) in limbs)
                button.Selected();

            DrawLimbDamage(damage);
            LimbDamageLabel.Text = $"[font size=16]{Loc.GetString("health-analyzer-body-all")}[/font]";
        }
    }

    private void DrawLimbDamage(DamageSpecifier damage)
    {
        var damageSortedGroups =
            damage.GetDamagePerGroup(Prototypes).OrderByDescending(damage => damage.Value)
                .ToDictionary(x => x.Key, x => x.Value);

        GroupsContainer.RemoveAllChildren();
        foreach (var container in DrawDiagnosticGroups(damageSortedGroups, damage.DamageDict, 1.125f))
            GroupsContainer.AddChild(container);
    }

    private HealthAnalyzerBodyProgressBar GetProgressBar(HealthAnalyzerBodyItemBarPosition position)
    {
        return position switch
        {
            HealthAnalyzerBodyItemBarPosition.TopLeft => ProgressBarTopLeft,
            HealthAnalyzerBodyItemBarPosition.TopCenter => ProgressBarTopCenter,
            HealthAnalyzerBodyItemBarPosition.TopRight => ProgressBarTopRight,

            HealthAnalyzerBodyItemBarPosition.MiddleLeft => ProgressBarMiddleLeft,
            HealthAnalyzerBodyItemBarPosition.MiddleCenter => ProgressBarMiddleCenter,
            HealthAnalyzerBodyItemBarPosition.MiddleRight => ProgressBarMiddleRight,

            HealthAnalyzerBodyItemBarPosition.BottomLeft => ProgressBarBottomLeft,
            HealthAnalyzerBodyItemBarPosition.BottomCenter => ProgressBarBottomCenter,
            HealthAnalyzerBodyItemBarPosition.BottomRight => ProgressBarBottomRight,

            _ => throw new NotImplementedException(),
        };
    }
}
