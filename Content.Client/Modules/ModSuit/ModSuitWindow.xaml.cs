using Content.Shared.Modules.ModSuit.UI;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.Modules.ModSuit;

[GenerateTypedNameReferences]
public sealed partial class ModSuitWindow : DefaultWindow
{
    private KeyValuePair<NetEntity, ModSuitSealableBuiEntry>[] _sealableParts = [];

    public event Action<NetEntity, bool>? OnSealButtonPressed;

    public ModSuitWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void Refresh()
    {
        RefreshSealableIcons();
    }

    #region Sealable

    public void UpdateSealed(ModSuitSealableBoundUserInterfaceState state)
    {
        _sealableParts = state.Parts;
        RefreshSealableIcons();
    }

    internal void RefreshSealableIcons()
    {
        SealContainer.Visible = _sealableParts.Any();
        SealPanel.RemoveAllChildren();
        SealButtons.RemoveAllChildren();

        foreach (var (part, data) in _sealableParts)
        {
            var spriteView = new ModSuitSealableSprite(data.Sprite[data.IsSealed]);
            SealPanel.AddChild(spriteView);

            var button = new ModSuitSealableButton(part, data.IsSealed);
            SealButtons.AddChild(button);

            button.ButtonButton.OnPressed += _ =>
            {
                OnSealButtonPressed?.Invoke(part, !data.IsSealed);

                // update the ui while we wait for the server to respond
                List<Control> proceedingChild = [];
                var foundSprite = false;
                var enumerator = SealPanel.Children.GetEnumerator();
                while (enumerator.MoveNext())
                {
                    if (!foundSprite)
                    {
                        if (enumerator.Current == spriteView)
                            foundSprite = true;

                        continue;
                    }

                    proceedingChild.Add(enumerator.Current);
                }

                SealPanel.RemoveChild(spriteView);

                foreach (var child in proceedingChild)
                    SealPanel.RemoveChild(child);

                var newSprite = new ModSuitSealableSprite(data.Sprite[!data.IsSealed]);
                SealPanel.AddChild(newSprite);

                foreach (var child in proceedingChild)
                    SealPanel.AddChild(child);
            };
        }
    }

    #endregion
}
