using Content.Shared.PDA.Messaging;
using Content.Shared.PDA.Messaging.Recipients;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using System.Linq;

namespace Content.Client.CartridgeLoader.Cartridges;

[GenerateTypedNameReferences]
public sealed partial class ChatUiFragmentSettings : BoxContainer, IChatUiFragmentMode
{
    public event Action<BasePdaChatMessageable>? OnBackButtonPressed;
    public event Action? OnHomeButtonPressed;

    public event Action<ProtoId<PdaChatProfilePicturePrototype>>? OnProfilePicturePicked;

    public event Action<NetEntity>? OnServerChangePicked;

    public event Action<BaseChatUiFragmentPopup>? OnPopupAdd;

    private BasePdaChatMessageable? _recipient;

    private NetEntity[] _serverIds = [];

    public ChatUiFragmentSettings()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        HomeButton.OnPressed += _ => OnHomeButtonPressed?.Invoke();
        BackButton.OnPressed += _ => OnBackButtonPressed?.Invoke(_recipient!);

        ProfileIconSelector.OnNewPopup += popup => OnPopupAdd?.Invoke(popup);
        ProfileIconSelector.OnProfilePicturePicked += picture => OnProfilePicturePicked?.Invoke(picture);
        ServerSelection.OnItemSelected += selected => OnServerChangePicked?.Invoke(_serverIds[selected.Id]);
    }

    public void UpdateState(PdaChatRecipientProfile profile, BasePdaChatMessageable? recipient, Dictionary<NetEntity, string> servers, NetEntity? currentServer)
    {
        _recipient = recipient;
        BackButton.Visible = recipient != null;

        ProfileIconSelector.CurrentPicture = profile.Picture;
        ProfileName.Text = Loc.GetString(profile.GetUiName());

        ServerSelection.Clear();
        var anyServers = servers.Any();
        ServerSelection.Visible = anyServers;
        ServerSelectionNone.Visible = !anyServers;
        if (anyServers)
        {
            _serverIds = new NetEntity[servers.Count];

            var i = 0;
            foreach (var (server, serverId) in servers)
            {
                ServerSelection.AddItem(serverId, i);

                if (server == currentServer)
                    ServerSelection.SelectId(i);

                _serverIds[i++] = server;
            }
        }
    }
}
